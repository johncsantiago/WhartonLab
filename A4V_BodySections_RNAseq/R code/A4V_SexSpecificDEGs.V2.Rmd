---
title: "A4V PCA"
author: "John Santiago"
date: "2024-01-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=F, include=F}

library(plotly)
library(edgeR)
library(goseq)
library(org.Dm.eg.db)
library(rrvgo)
library(VennDiagram)
library(pathview)
library(visNetwork)
library(pathview)
library(rstudioapi)
library(clusterProfiler)

```

```{r echo = F}
counts = read.csv("/Users/johncsantiago/Documents/GitHub/WhartonLab/A4V_BodySections_RNAseq/A4V.countdata.csv", row.names = 1)

cpm = read.csv("/Users/johncsantiago/Documents/GitHub/WhartonLab/A4V_BodySections_RNAseq/A4V.cpmdata.csv", row.names = 1)

meancpm = read.csv("/Users/johncsantiago/Documents/GitHub/WhartonLab/A4V_BodySections_RNAseq/A4V.meancpmdata.csv", row.names = 1)

FDR = read.csv("/Users/johncsantiago/Documents/GitHub/WhartonLab/A4V_BodySections_RNAseq/A4V.FDRdata.csv", row.names = 1)

FC = read.csv("/Users/johncsantiago/Documents/GitHub/WhartonLab/A4V_BodySections_RNAseq/A4V.FCdata.csv", row.names = 1)

meta = read.csv("/Users/johncsantiago/Documents/GitHub/WhartonLab/A4V_BodySections_RNAseq/A4V.metadata.csv", row.names = 1)

GeneIDKey = read.csv("/Users/johncsantiago/Documents/GitHub/WhartonLab/GeneralDataFiles/GeneIDKey.csv", row.names = 1)

KEGG.Key = read.csv("/Users/johncsantiago/Documents/GitHub/WhartonLab/Metabolomics/RawMetabolomicData.csv", row.names = 1)
KEGG.Key = setNames(KEGG.Key[-c(1:2), 2], row.names(KEGG.Key)[-c(1:2)])

genesingo=as.list(org.Dm.egGO2ALLEGS)

git.dir = "https://raw.githubusercontent.com/johncsantiago/WhartonLab/master/"
GR.cpm = read.csv(paste0(git.dir,"TKT_RNAseq/CountTables/TKT_cpmdata.csv"),row.names = 1)
GR.meta  = read.csv(paste0(git.dir,"TKT_RNAseq/CountTables/TKT.metadata.csv"),row.names = 1)
GR.FDR = read.csv(paste0(git.dir,"TKT_RNAseq/CountTables/TKT.EdgeR.FDRTable.csv"),row.names = 1)
kegg = readRDS(gzcon(url(paste0(git.dir,"GeneralDataFiles/kegg.symbol2path.RData"))))
kegg.names = read.csv(paste0(git.dir, "GeneralDataFiles/KEGG.names.csv"), row.names = 1)


```



```{r echo = F, include = F}

Enrichment = function(sigs, bg){
  sigsKEY = GeneIDKey[sigs,]
  sigs = na.omit(sigsKEY$Symbol)
  bgKEY = GeneIDKey[bg,]
  bg = na.omit(bgKEY$Symbol)

  genes = setNames(rep(0, length(bg)), bg)
  genes[sigs] = 1
  pwf=nullp(genes,"dm3","geneSymbol")
  GO.wall=goseq(pwf,"dm3","geneSymbol")
  GO.wall$adjp=p.adjust(GO.wall$over_represented_pvalue,method="BH")
  row.names(GO.wall) = GO.wall$category
  KEGG=goseq(pwf,gene2cat=kegg)
  KEGG$adjp=p.adjust(KEGG$over_represented_pvalue,method="BH")
  row.names(KEGG)=substr(as.character(KEGG[,1]),6,13)
  KEGG$Name=kegg.names[row.names(KEGG),1]

  enrichment.data = list(GO.wall, KEGG)
  names(enrichment.data) = c("GO", "KEGG")
  return(enrichment.data)
}

```

```{r echo = F, include = F}

GO.Sim.PCA = function(use.data){
    pca <- prcomp(t(use.data), scale.=TRUE) 
    pc1=scale(pca$x[,1])
    pc2=scale(pca$x[,2])
    eigs <- pca$sdev^2
    ve=signif(((eigs / sum(eigs))*100)[1:3],4)

    pca.data=data.frame(PC1=pc1,
                        PC2=pc2,
                        sdev=pca$sdev,
                        Percent1=ve[1],
                        Percent2=ve[2],
                        Group = use.data[row.names(use.data), "parentTerm"],
                        Score = use.data[row.names(use.data), "score"],
                        Term = use.data[row.names(use.data), "term"],
                        TotalDE = GO.data[row.names(use.data), "numDEInCat"],
                        Total = GO.data[row.names(use.data), "numInCat"],
                        SigVal = signif(GO.data[row.names(use.data), "adjp"],3))

    pca.data$Group = factor(pca.data$Group, levels = unique(pca.data$Group))
    pca.data$Score = 20*(1+pca.data$Score/mean(pca.data$Score))
    
  fig  = plot_ly(data = pca.data, 
                 x = ~PC1, 
                 y = ~PC2,
                 name = ~Group,
                 type = 'scatter',
                 mode = 'markers',
                 showlegend = T,
                 color = ~Group,
                 ##symbol = ~Group,
                 ##symbols = as.character(seq_along(unique(point.data$Set))),
                 ##colors = c("firebrick","gold","deepskyblue"),
                 marker = list(size = pca.data$Score,
                               line = list(color = "black", width = 1.5)),
                 hoverinfo = "text",
                 hovertext = paste("Parent Group: ", pca.data$Group,
                                   "\nSample: ", pca.data$Term, 
                                   "\nTotal DE: ", pca.data$TotalDE, 
                                   "\nTotal in Cat.: ", pca.data$Total, 
                                   "\nFDR: ", pca.data$SigVal)) %>%
    layout(xaxis = list(title = paste0("PC1", "(", ve[1], "%)")),
           yaxis = list(title = paste0("PC2", "(", ve[2], "%)")),
           title = "Enriched GO term similarity")
           
  return(fig)
}

```

```{r echo = F, include =F}

GO20 = function(GO.data, GO.ontology, FC.data, FDR.data){
GO.data = GO.data[GO.data$ontology == GO.ontology,
                  c("category", "term","adjp", "numDEInCat", "numInCat")]

data = GO.data[20:1,c("term","adjp","numDEInCat", "numInCat", "category")]
data$Score = -log10(data$adjp)

temp = nchar(data$term)
data$label = data$term
data$label[temp > 40] = paste0(substr(data$term[temp>40], 1 ,35), "...")

data$term = factor(data$term, levels = c(unique(data$term)))
data$up = 0
data$down = 0
data$allup = 0
data$alldown = 0

sigs = names(FDR.data[FDR.data <= 0.05])

i = 1
while(i <= nrow(data)){
  go.id = row.names(data)[i]
  go.genes = genesingo[[go.id]]
  go.genes = GeneIDKey[GeneIDKey$ensembl %in% go.genes, "FBgn"]
  go.genes = intersect(go.genes, names(FC.data))
  sig.go.genes = intersect(go.genes, sigs)
  go.FC = FC.data[go.genes]
  sig.go.FC = FC.data[sig.go.genes]  
  
  data$allup[i] = length(go.FC[go.FC>0])
  data$alldown[i] = length(go.FC[go.FC<0])
  data$up[i] = length(sig.go.FC[sig.go.FC>0])
  data$down[i] = length(sig.go.FC[sig.go.FC<0])
  i = i +1
}

data$down = data$down * -1
data$alldown = data$alldown * -1

m <- list(
  l = 50,
  r = 50,
  b = 100,
  t = 100,
  pad = 4
)



fig <- plot_ly(data, 
               x = ~up, y = ~label, 
               type = 'bar',
               name = "Sig. Increased FC",
               marker = list(color = 'brown',
                             line = list(color = "black", width = 1.5)),
    hoverinfo = "text",
    hovertext = paste("Sample:", data$term,
                      "\nGO ID: ", data$category,
                      "\nTotal DE: ", data$numDEInCat,
                      "\nTotal in Cat.: ", data$numInCat,
                      "\nDE up: ", data$up,
                      "\nDE down: ", data$down,
                      "\nFDR: ", signif(data$adjp, 3))) %>%
    add_trace(x = ~down, 
              y ~term, 
              marker = list(color = 'steelblue', 
                            line = list(color = "black", width = 1.5)), 
              name = "Sig. Decreased FC")%>%
   
    layout(xaxis = list(title = "Number of Genes"),
           yaxis = list(title = ""),
           title = paste0("Top 20 Most Enriched ",GO.ontology, " GO Terms"),
           margin = m, barmode = 'overlay')

  return(fig)
}

```

```{r, echo = F, include = F}

KEGG20 = function(KEGG.data, FC.data, FDR.data){
  
data = KEGG.data[, c("category", "Name","adjp", "numDEInCat", "numInCat")]
  
data$term = data$Name
if(length(unique(data$term)) < length(data$term)){
  data$term[duplicated(data$term)] = paste(data$term[duplicated(data$term)], "2")
}  
data = na.omit(data[data$Name != 'Metabolic pathways',])
data = data[20:1,]
data$Score = -log10(data$adjp)
data$term = factor(data$term, levels = c(unique(data$term)))
data$up = 0
data$down = 0
data$allup = 0
data$alldown = 0

sigs = names(FDR.data[FDR.data <= 0.05])

i = 1
while(i <= nrow(data)){
  kegg.id = data$category[i]
  kegg.genes = names(kegg[grep(kegg.id, kegg)])
  kegg.genes = GeneIDKey[GeneIDKey$Symbol %in% kegg.genes, "FBgn"]
  kegg.genes = intersect(kegg.genes, names(FC.data))
  sig.kegg.genes = intersect(kegg.genes, sigs)
  kegg.FC = FC.data[kegg.genes]
  sig.kegg.FC = FC.data[sig.kegg.genes]
  data$allup[i] = length(kegg.FC[kegg.FC>0])
  data$alldown[i] = length(kegg.FC[kegg.FC<0])
  data$up[i] = length(sig.kegg.FC[sig.kegg.FC>0])
  data$down[i] = length(sig.kegg.FC[sig.kegg.FC<0])
  i = i +1
}

data$down = data$down * -1
data$alldown = data$alldown * -1


m <- list(
  l = 50,
  r = 50,
  b = 100,
  t = 100,
  pad = 4
)

fig <- plot_ly(data, 
               x = ~up, y = ~term, 
               type = 'bar',
               name = "Sig. Increased FC",
               marker = list(color = 'brown',
                             line = list(color = "black", width = 1.5)),
    hoverinfo = "text",
    hovertext = paste("Sample:", data$term,
                      "\nGO ID: ", data$category,
                      "\nTotal DE: ", data$numDEInCat,
                      "\nTotal in Cat.: ", data$numInCat,
                      "\nDE up: ", data$up,
                      "\nDE down: ", data$down,
                      "\nFDR: ", signif(data$adjp, 3))) %>%
    add_trace(x = ~down, 
              y ~term, 
              marker = list(color = 'steelblue', 
                            line = list(color = "black", width = 1.5)), 
              name = "Sig. Decreased FC")%>%
    layout(xaxis = list(title = "Number of Genes"),
           yaxis = list(title = ""),
           title = paste0("Top 20 Most Enriched ", GO.ontology, " GO Terms"),
           margin = m, barmode = 'overlay')

return(fig)

}

```



```{r echo = F}

KEGG.diagram = function(PathwayID, out.id, FC.data, FDR.data){
  ##KEGG Mapping Function
  if(length(intersect(list.files(), "KEGG_Image_Files")) == 0){
    dir.create(paste0(dirname(rstudioapi::getSourceEditorContext()$path), "/KEGG_Image_Files/"))
    }
  Home = dirname(rstudioapi::getSourceEditorContext()$path)
  OutputDir = paste0(Home, "/KEGG_Image_Files/")
  setwd(OutputDir)
  sigs = names(FDR.data[FDR.data <= .05])
  deg.data=setNames(FC.data[sigs],GeneIDKey[sigs, "ensembl"])
  
  pv.out <- pathview(gene.data =  deg.data,
                   pathway.id = PathwayID,
                   species = "dme",
                   kegg.native = T,
                   limit=list(gene=c(-2,2)),
                   node.sum="max.abs",
                   low="royalblue",mid = "grey",high="firebrick",
                   out.suffix = out.id,
                   bins=list(genes=30))
  setwd(Home)
  knitr::include_graphics(paste0(OutputDir, "dme",PathwayID, ".", out.id, ".png"))
}



```

##Using all DEGs from the A9MT vs S9MT comparison
### (no minimum mean cpm cutoff or background factor DEG exclusion)
```{r echo = F}

cutoff=0

##T9 = setdiff(row.names(FDR)[FDR[,'AvS9MT']<.05], row.names(FDR)[FDR[,'AvS9FT']<.05])
T9 = row.names(FDR)[FDR[,'AvS9MT']<.05]
T9 = T9[apply(meancpm[T9, c("A9FT", "A9MT", "S9FT", "S9MT")],MARGIN = 1, mean)>cutoff]



```



```{r include = F, echo = F}

sigs = T9
bg = row.names(FDR)

sig.cats = Enrichment(sigs, bg)
thorax.cats = sig.cats

```


```{r echo =F, include =F}

GO.data = sig.cats[["GO"]]
GO.ontology = "CC"
go_analysis = GO.data$category[GO.data$over_represented_pvalue <= .005 & GO.data$ontology == GO.ontology]
scores = setNames(-log10(GO.data$over_represented_pvalue), go_analysis)

CC.simMatrix <- calculateSimMatrix(go_analysis,
                                orgdb="org.Dm.eg.db",
                                ont=GO.ontology,
                                method="Rel")

CC.reducedTerms <- reduceSimMatrix(CC.simMatrix,
                                scores,
                                threshold=0.7,
                                orgdb="org.Dm.eg.db")

```


```{r echo =F, include =F}

GO.data = sig.cats[["GO"]]
GO.ontology = "BP"
go_analysis = GO.data$category[GO.data$over_represented_pvalue <= .005 & GO.data$ontology == GO.ontology]
scores = setNames(-log10(GO.data$over_represented_pvalue), go_analysis)

BP.simMatrix <- calculateSimMatrix(go_analysis,
                                orgdb="org.Dm.eg.db",
                                ont=GO.ontology,
                                method="Rel")

BP.reducedTerms <- reduceSimMatrix(BP.simMatrix,
                                scores,
                                threshold=0.7,
                                orgdb="org.Dm.eg.db")

```


```{r echo =F, include =F}

GO.data = sig.cats[["GO"]]
GO.ontology = "MF"
go_analysis = GO.data$category[GO.data$over_represented_pvalue <= .005 & GO.data$ontology == GO.ontology]
scores = setNames(-log10(GO.data$over_represented_pvalue), go_analysis)

MF.simMatrix <- calculateSimMatrix(go_analysis,
                                orgdb="org.Dm.eg.db",
                                ont=GO.ontology,
                                method="Rel")

MF.reducedTerms <- reduceSimMatrix(MF.simMatrix,
                                scores,
                                threshold=0.7,
                                orgdb="org.Dm.eg.db")

```


```{r echo = F, include =F}

FC.data = setNames(FC$AvS9MT, row.names(FC))
FDR.data = setNames(FDR$AvS9MT, row.names(FDR))

GO.data = sig.cats[["GO"]]
GO.ontology = "BP"
BP.GO.fig = GO20(GO.data, GO.ontology, FC.data, FDR.data)

GO.ontology = "CC"
CC.GO.fig = GO20(GO.data, GO.ontology, FC.data, FDR.data)

GO.ontology = "MF"
MF.GO.fig = GO20(GO.data, GO.ontology, FC.data, FDR.data)

KEGG.data = sig.cats[["KEGG"]]
KEGG.fig = KEGG20(KEGG.data, FC.data, FDR.data)

```




9 Day Thorax Biological Process GO Terms
```{r, echo = F,  fig.width= 10}

BP.GO.fig

```


9 Day Thorax Biological Process GO Terms
```{r  echo = F, fig.align='left'}

treemapPlot(BP.reducedTerms)

```

9 Day Thorax Cellular Component GO Terms
```{r, echo = F,  fig.width= 10}

CC.GO.fig

```



9 Day Thorax Cellular Component GO Terms
```{r  echo = F, fig.align='left'}

treemapPlot(CC.reducedTerms)

```


9 Day Thorax Molecular Function GO Terms
```{r, echo = F,  fig.width= 10}

MF.GO.fig

```



9 Day Thorax Molecular Function GO Terms
```{r  echo = F, fig.align='left'}

treemapPlot(MF.reducedTerms)

```


9 Day Thorax KEGG Pathways
```{r, echo = F,  fig.width= 10}

KEGG.fig

```




```{r echo = F, include=T, message = F, fig.align='center'}

PathwayID = "04146"
out.id = 'AvS9T'
KEGG.diagram(PathwayID, out.id, FC.data, FDR.data)


```

```{r echo = F, include = T}

##NMJ = GO:0031594
##synapse = GO:0045202

specific.cat = c('none', 'parent.category', 'specific.kegg', 'specific.go', "BP.parent.category", "MF.parent.category")

specific.cat = specific.cat[2]
parent.category = 'peroxisome'
specific.kegg = "none"
specific.go =  '0042579'

set.size = F
  
specific.cat = 'none'

if(length(intersect(parent.category, CC.reducedTerms$parentTerm))){
  rt = CC.reducedTerms
  specific.cat = 'parent.category'
}

if(length(intersect(parent.category, BP.reducedTerms$parentTerm))){
  rt = BP.reducedTerms
  specific.cat = 'parent.category'
}

if(length(intersect(parent.category, MF.reducedTerms$parentTerm))){
  rt = MF.reducedTerms
  specific.cat = 'parent.category'
}

GOterm.genes = vector('list', length = length(unique(rt$parent)))
names(GOterm.genes) = unique(rt$parent)
i=1
while(i<=length(GOterm.genes)){
  goinparent = rt[grep(names(GOterm.genes)[i], rt$parent),'go']
  genesinparent = unlist(genesingo[goinparent])
  GOterm.genes[[i]] = GeneIDKey[GeneIDKey$ensembl %in% genesinparent, 'FBgn']
  i = i +1
}

volcano.data = data.frame(Symbol = GeneIDKey[T9, "Symbol"], 
                          FDR = -log2(FDR[T9, 'AvS9MT']),
                          FC = FC[T9, 'AvS9MT'],
                          Color = 'grey',
                          size = 3*log(meancpm[T9,"A9MT"]),
                          M.cpm = meancpm[T9,"A9MT"],
                          F.cpm = meancpm[T9,"A9FT"],
                          SM.cpm = meancpm[T9,"S9MT"],
                          SF.cpm = meancpm[T9,"S9FT"],
                          GO.terms = "none")

main.title = ""

volcano.data$Color[volcano.data$FDR >= -log2(.05) & volcano.data$FC < 0] = 'lightblue'
volcano.data$Color[volcano.data$FDR >= -log2(.0001) & volcano.data$FC < 0] = 'steelblue'
volcano.data$Color[volcano.data$FDR >= -log2(.000001) & volcano.data$FC < 0] = 'dodgerblue'

volcano.data$Color[volcano.data$FDR >= -log2(.05) & volcano.data$FC > 0] = 'lightcoral'
volcano.data$Color[volcano.data$FDR >= -log2(.0001) & volcano.data$FC > 0] = 'tomato'
volcano.data$Color[volcano.data$FDR >= -log2(.000001) & volcano.data$FC > 0] = 'firebrick'

volcano.data$size[volcano.data$FDR <= -log2(.05)] = 3

if(set.size == T){
  volcano.data$size = 15
  volcano.data$size[volcano.data$FDR <= -log2(.05)] = 5
}


if(specific.cat == 'parent.category'){
  parent.genes = GOterm.genes[[intersect(rt[rt$parentTerm == parent.category, "go"], names(GOterm.genes))]]
  parent.genes = intersect(parent.genes, row.names(volcano.data))
  volcano.data$Color = 'honeydew'
  volcano.data[parent.genes, 'Color'] = 'deeppink'
  volcano.data = volcano.data[order(volcano.data$Color, decreasing = T),]
  main.title = sig.cats$GO[c(grep(parent.category, sig.cats$GO$term), grep(parent.category, sig.cats$GO$category)), 'term']
  main.title = parent.category
}





if(specific.cat == 'specific.kegg'){
  kegg.id = sig.cats$KEGG[c(grep(specific.kegg, sig.cats$KEGG$Name), grep(specific.kegg, sig.cats$KEGG$category)), 'category']
  kegg.genes = names(kegg[grep(kegg.id, kegg)])
  volcano.data$Color = 'honeydew'
  row.names(volcano.data) = volcano.data$Symbol
    volcano.data[kegg.genes, 'Color'] = 'deeppink'
  volcano.data = volcano.data[order(volcano.data$Color, decreasing = T),]
  main.title = sig.cats$KEGG[c(grep(specific.kegg, sig.cats$KEGG$Name), grep(specific.kegg, sig.cats$KEGG$category)), 'Name']
}


if(specific.cat == 'none'){
  go.id = sig.cats$GO[c(grep(specific.go, sig.cats$GO$term), grep(specific.go, sig.cats$GO$category)), 'category']
  volcano.data$Color = 'honeydew'
  go.genes = genesingo[[go.id]]
  go.genes = GeneIDKey[GeneIDKey$ensembl %in% go.genes, "FBgn"]
  go.genes = intersect(go.genes, row.names(volcano.data))
  volcano.data[go.genes, 'Color'] = 'deeppink'
  volcano.data = volcano.data[order(volcano.data$Color, decreasing = T),]
  main.title = sig.cats$GO[c(grep(specific.go, sig.cats$GO$term), grep(specific.go, sig.cats$GO$category)), 'term']
}

##volcano.data


fig = plot_ly(data = volcano.data,
              x = ~FC,
              y = ~FDR,
              type = 'scatter',
              mode = 'markers',
              marker = list(color = ~Color, colors = ~Color, size = volcano.data$size,
                            line = list(color = 'black', width = .5)),
              hoverinfo = "text",
              hovertext = paste("Gene:", volcano.data$Symbol,
                      "\n-log2(FDR): ", round(volcano.data$FDR,2),
                      "\nFC: ", round(volcano.data$FC,2),
                      "\nA4V Male Thorax mean cpm: ", round(volcano.data$M.cpm, 1),
                      "\nA4V Female Thorax mean cpm: ", round(volcano.data$F.cpm, 1),
                      "\nSilent Male Thorax mean cpm: ", round(volcano.data$SM.cpm, 1),
                      "\nSilent Female Thorax mean cpm: ", round(volcano.data$SF.cpm, 1)))
fig = fig %>% layout(title = main.title)

              ##color = ~Color,
              ##colors = 'Spectral')
              ##color = ~Color,
              ##colors = ~Color)
              ##marker = list(colorscale = list(c(0,.5,1), c("blue","yellow", "red")), color = ~Color))

fig


```

```{r echo = F, include = T}


category = 'neuromuscular junction'
plot.all = F
set.size = F
  


volcano.data = data.frame(Symbol = GeneIDKey[T9, "Symbol"], 
                          FDR = -log2(FDR[T9, 'AvS9MT']),
                          MFC = FC[T9, 'AvS9MT'],
                          FFC = FC[T9, 'AvS9FT'],
                          ##size = 3*log(meancpm[T9,"A9MT"]),
                          size = -log2(FDR[T9, 'AvS9MT']),
                          M.cpm = meancpm[T9,"A9MT"],
                          F.cpm = meancpm[T9,"A9FT"],
                          SM.cpm = meancpm[T9,"S9MT"],
                          SF.cpm = meancpm[T9,"S9FT"],
                          GO.terms = "none",
                          Color = FC[T9, 'AvS9MT'] - FC[T9, 'AvS9FT'])
row.names(volcano.data) = T9

main.title = ""


specific.cat = 'none'

if(length(intersect(category, sig.cats$GO$category))){
  specific.cat = 'specific.go'
  specific.go = sig.cats$GO$category[sig.cats$GO$category == category]
}

if(length(intersect(category, sig.cats$GO$term))){
  specific.cat = 'specific.go'
  specific.go = sig.cats$GO$category[sig.cats$GO$term == category]
}

if(length(grep(category, sig.cats$KEGG$Name))){
  specific.cat = 'specific.kegg'
  specific.kegg = sig.cats$KEGG$category[grep(category, sig.cats$KEGG$Name)]
}

if(length(grep(category, sig.cats$KEGG$category))){
  specific.cat = 'specific.kegg'
  specific.kegg = sig.cats$KEGG$category[grep(category, sig.cats$KEGG$category)]
}

if(length(intersect(category, CC.reducedTerms$parentTerm))){
  rt = CC.reducedTerms
  specific.cat = 'parent.category'
}

if(length(intersect(category, BP.reducedTerms$parentTerm))){
  rt = BP.reducedTerms
  specific.cat = 'parent.category'
}

if(length(intersect(category, MF.reducedTerms$parentTerm))){
  rt = MF.reducedTerms
  specific.cat = 'parent.category'
}

GOterm.genes = vector('list', length = length(unique(rt$parent)))
names(GOterm.genes) = unique(rt$parent)
i=1
while(i<=length(GOterm.genes)){
  goinparent = rt[grep(names(GOterm.genes)[i], rt$parent),'go']
  genesinparent = unlist(genesingo[goinparent])
  GOterm.genes[[i]] = GeneIDKey[GeneIDKey$ensembl %in% genesinparent, 'FBgn']
  i = i +1
}

volcano.data$size[volcano.data$FDR <= -log2(.05)] = 3

if(set.size == T){
  volcano.data$size = 15
  volcano.data$size[volcano.data$FDR <= -log2(.05)] = 5
}


if(specific.cat == 'parent.category'){
  parent.genes = GOterm.genes[[intersect(rt[rt$parentTerm == parent.category, "go"], names(GOterm.genes))]]
  parent.genes = intersect(parent.genes, row.names(volcano.data))
  volcano.data$Color = 'honeydew'
  volcano.data[parent.genes, 'Color'] = 'deeppink'
  volcano.data = volcano.data[order(volcano.data$Color, decreasing = T),]
  main.title = sig.cats$GO[c(grep(parent.category, sig.cats$GO$term), grep(parent.category, sig.cats$GO$category)), 'term']
  main.title = parent.category
}


if(specific.cat == 'specific.kegg'){
  kegg.id = sig.cats$KEGG[c(grep(specific.kegg, sig.cats$KEGG$Name), grep(specific.kegg, sig.cats$KEGG$category)), 'category']
  kegg.genes = names(kegg[grep(kegg.id, kegg)])
  volcano.data$Color = 'honeydew'
  row.names(volcano.data) = volcano.data$Symbol
    volcano.data[kegg.genes, 'Color'] = 'deeppink'
  volcano.data = volcano.data[order(volcano.data$Color, decreasing = T),]
  main.title = sig.cats$KEGG[c(grep(specific.kegg, sig.cats$KEGG$Name), grep(specific.kegg, sig.cats$KEGG$category)), 'Name']
}


if(specific.cat == 'specific.go'){
  go.id = sig.cats$GO[c(grep(specific.go, sig.cats$GO$term), grep(specific.go, sig.cats$GO$category)), 'category']
  volcano.data$Color = 'honeydew'
  go.genes = genesingo[[go.id]]
  go.genes = GeneIDKey[GeneIDKey$ensembl %in% go.genes, "FBgn"]
  go.genes = intersect(go.genes, row.names(volcano.data))
  volcano.data[go.genes, 'Color'] = 'deeppink'
  volcano.data = volcano.data[order(volcano.data$Color, decreasing = T),]
  main.title = sig.cats$GO[c(grep(specific.go, sig.cats$GO$term), grep(specific.go, sig.cats$GO$category)), 'term']
}

if(plot.all == F){
  volcano.data = volcano.data[volcano.data$Color == "deeppink",]
}

fig = plot_ly(data = volcano.data,
              x = ~MFC,
              y = ~FFC,
              type = 'scatter',
              mode = 'markers',
              marker = list(colorscale = list(c(0,.45,1), c("firebrick","ivory", "royalblue")),
                            reversescale =T,
                             colorbar = list(title = "delta FC",
                                      len = .8, outlinewidth = 0,
                                      tickformat = ".2f",
                                      tick0 = 0),##, dtick = .01),
                             color = ~Color,
                             line = list(color = "black", width = 1.5),
                             size = volcano.data$size),
              hoverinfo = "text",
              hovertext = paste("Gene:", volcano.data$Symbol,
                      "\n-log2(FDR): ", round(volcano.data$FDR,2),
                      "\nMale FC: ", round(volcano.data$MFC,2),
                      "\nFemale FC: ", round(volcano.data$FFC,2),
                      "\nA4V Male Thorax mean cpm: ", round(volcano.data$M.cpm, 1),
                      "\nA4V Female Thorax mean cpm: ", round(volcano.data$F.cpm, 1),
                      "\nSilent Male Thorax mean cpm: ", round(volcano.data$SM.cpm, 1),
                      "\nSilent Female Thorax mean cpm: ", round(volcano.data$SF.cpm, 1)))
fig = fig %>% layout(title = main.title,
                     shapes = list(
                       type = "line",
                       line = list(color = "black", dash = 'dash', width = 2),
                       x0 = -10,
                       x1 = 10,
                       y0 = -10,
                       y1 = 10))

              ##color = ~Color,
              ##colors = 'Spectral')
              ##color = ~Color,
              ##colors = ~Color)
              ##marker = list(colorscale = list(c(0,.5,1), c("blue","yellow", "red")), color = ~Color))

fig


```

```{r echo = F, message = F}

FGO.data = Enrichment(row.names(FDR)[FDR$AvS9FT<.05], row.names(FDR))$GO
MGO.data = Enrichment(row.names(FDR)[FDR$AvS9MT<.05], row.names(FDR))$GO

ontology = "CC"
GO.data = MGO.data[MGO.data$ontology == ontology,
                  c("category", "term","adjp", "numDEInCat", "numInCat")]
GO.data$Female.adjp = FGO.data[row.names(GO.data), 'adjp']


data = GO.data[,c("term","numDEInCat", "numInCat", "category")]
data$MaleScore = -log10(GO.data$adjp)
data$FemaleScore = -log10(GO.data$Female.adjp)
data$term = factor(data$term, levels = c(unique(data$term)))
data$Fup = 0
data$Fdown = 0
data$Mup = 0
data$Mdown = 0
data$FmeanFC = 0
data$MmeanFC = 0

M.sigs = row.names(FDR[FDR$AvS9MT <= 0.05,])
F.sigs = row.names(FDR[FDR$AvS9FT <= 0.05,])
MFC = setNames(FC$AvS9MT, row.names(FC))
FFC = setNames(FC$AvS9FT, row.names(FC))

i = 1
while(i <= nrow(data)){
  go.id = row.names(data)[i]
  go.genes = genesingo[[go.id]]
  go.genes = GeneIDKey[GeneIDKey$ensembl %in% go.genes, "FBgn"]
  Mgo.genes = intersect(go.genes, M.sigs)
  Fgo.genes = intersect(go.genes, F.sigs)
  data$Fup[i] = length(Fgo.genes[FFC[Fgo.genes]>0])
  data$Fdown[i] = length(Fgo.genes[FFC[Fgo.genes]<0])
  data$Mup[i] = length(Mgo.genes[MFC[Mgo.genes]>0])
  data$Mdown[i] = length(Mgo.genes[MFC[Mgo.genes]<0])
  if(length(Fgo.genes)>0){
    data$FmeanFC[i] = mean(FFC[Fgo.genes])
  }
  if(length(Mgo.genes)>0){
    data$MmeanFC[i] = mean(MFC[Mgo.genes])
  }
  i = i +1
}

data$MTotalxFC = (data$MmeanFC*(data$Mup + data$Mdown))
data$FTotalxFC = (data$FmeanFC*(data$Fup + data$Fdown))

data$MTotalxFC[data$MTotalxFC != 0] = log(abs(data$MTotalxFC[data$MTotalxFC != 0]))*(data$MTotalxFC[data$MTotalxFC != 0]/abs(data$MTotalxFC[data$MTotalxFC != 0]))
data$FTotalxFC[data$FTotalxFC != 0] = log(abs(data$FTotalxFC[data$FTotalxFC != 0]))*(data$FTotalxFC[data$FTotalxFC != 0]/abs(data$FTotalxFC[data$FTotalxFC != 0]))

data$Color = data$MTotalxFC - data$FTotalxFC
data$Size = 5*log(data$numDEInCat)


fig = plot_ly(data = data,
              x = ~MTotalxFC,
              y = ~FTotalxFC,
              type = 'scatter',
              mode = 'markers',
              marker = list(colorscale = list(c(0,.45,1), c("firebrick","ivory", "royalblue")),
                            reversescale =T,
                             colorbar = list(title = "delta FC",
                                      len = .8, outlinewidth = 0,
                                      tickformat = ".2f",
                                      tick0 = 0),##, dtick = .01),
                             color = ~Color,
                             line = list(color = "black", width = 1.5),
                             size = ~Size),
              hoverinfo = "text",
              hovertext = paste("GOterm:", data$term,
                                "\nGO ID:", data$category,
                      "\nMale -log2(FDR): ", round(data$MaleScore,2),
                      "\nFemale -log2(FDR): ", round(data$FemaleScore,2),
                      "\nMale meanFC: ", round(data$MmeanFC,2),
                      "\nFemale meanFC: ", round(data$FmeanFC,2),
                      "\nIncrease FC DEG Males: ", round(data$Mup, 1),
                      "\nDecrease FC DEG Males: ", round(data$Mdown, 1),
                      "\nIncrease FC DEG Females: ", round(data$Fup, 1),
                      "\nDecrease FC DEG Females: ", round(data$Fdown, 1)))
fig = fig %>% layout(title = "",
                     shapes = list(
                       type = "line",
                       line = list(color = "black", dash = 'dash', width = 2),
                       x0 = -10,
                       x1 = 4,
                       y0 = -10,
                       y1 = 4))


fig

```


```{r echo = F, message = F}

##FGO.data = Enrichment(row.names(FDR)[FDR$AvS9FT<.05], row.names(FDR))$GO
##MGO.data = Enrichment(row.names(FDR)[FDR$AvS9MT<.05], row.names(FDR))$GO

ontology = "BP"
GO.data = MGO.data[MGO.data$ontology == ontology,
                  c("category", "term","adjp", "numDEInCat", "numInCat")]
GO.data$Female.adjp = FGO.data[row.names(GO.data), 'adjp']


data = GO.data[,c("term","numDEInCat", "numInCat", "category")]
data$MaleScore = -log10(GO.data$adjp)
data$FemaleScore = -log10(GO.data$Female.adjp)
data$term = factor(data$term, levels = c(unique(data$term)))
data$Fup = 0
data$Fdown = 0
data$Mup = 0
data$Mdown = 0
data$FmeanFC = 0
data$MmeanFC = 0

M.sigs = row.names(FDR[FDR$AvS9MT <= 0.05,])
F.sigs = row.names(FDR[FDR$AvS9FT <= 0.05,])
MFC = setNames(FC$AvS9MT, row.names(FC))
FFC = setNames(FC$AvS9FT, row.names(FC))

i = 1
while(i <= nrow(data)){
  go.id = row.names(data)[i]
  go.genes = genesingo[[go.id]]
  go.genes = GeneIDKey[GeneIDKey$ensembl %in% go.genes, "FBgn"]
  Mgo.genes = intersect(go.genes, M.sigs)
  Fgo.genes = intersect(go.genes, F.sigs)
  data$Fup[i] = length(Fgo.genes[FFC[Fgo.genes]>0])
  data$Fdown[i] = length(Fgo.genes[FFC[Fgo.genes]<0])
  data$Mup[i] = length(Mgo.genes[MFC[Mgo.genes]>0])
  data$Mdown[i] = length(Mgo.genes[MFC[Mgo.genes]<0])
  if(length(Fgo.genes)>0){
    data$FmeanFC[i] = mean(FFC[Fgo.genes])
  }
  if(length(Mgo.genes)>0){
    data$MmeanFC[i] = mean(MFC[Mgo.genes])
  }
  i = i +1
}

data$MTotalxFC = (data$MmeanFC*(data$Mup + data$Mdown))
data$FTotalxFC = (data$FmeanFC*(data$Fup + data$Fdown))

data$MTotalxFC[data$MTotalxFC != 0] = log(abs(data$MTotalxFC[data$MTotalxFC != 0]))*(data$MTotalxFC[data$MTotalxFC != 0]/abs(data$MTotalxFC[data$MTotalxFC != 0]))
data$FTotalxFC[data$FTotalxFC != 0] = log(abs(data$FTotalxFC[data$FTotalxFC != 0]))*(data$FTotalxFC[data$FTotalxFC != 0]/abs(data$FTotalxFC[data$FTotalxFC != 0]))

data$Color = data$MTotalxFC - data$FTotalxFC
data$Size = 10*log10(data$numDEInCat)


fig = plot_ly(data = data,
              x = ~MTotalxFC,
              y = ~FTotalxFC,
              type = 'scatter',
              mode = 'markers',
              marker = list(colorscale = list(c(0,.5,1), c("firebrick","ivory", "royalblue")),
                            reversescale =T,
                             colorbar = list(title = "delta FC",
                                      len = .8, outlinewidth = 0,
                                      tickformat = ".2f",
                                      tick0 = 0),##, dtick = .01),
                             color = ~Color,
                             line = list(color = "black", width = 1.5),
                             size = ~Size),
              hoverinfo = "text",
              hovertext = paste("GOterm:", data$term,
                                "\nGO ID:", data$category,
                      "\nMale -log2(FDR): ", round(data$MaleScore,2),
                      "\nFemale -log2(FDR): ", round(data$FemaleScore,2),
                      "\nMale meanFC: ", round(data$MmeanFC,2),
                      "\nFemale meanFC: ", round(data$FmeanFC,2),
                      "\nIncrease FC DEG Males: ", round(data$Mup, 1),
                      "\nDecrease FC DEG Males: ", round(data$Mdown, 1),
                      "\nIncrease FC DEG Females: ", round(data$Fup, 1),
                      "\nDecrease FC DEG Females: ", round(data$Fdown, 1)))
fig = fig %>% layout(title = "",
                     shapes = list(
                       type = "line",
                       line = list(color = "black", dash = 'dash', width = 2),
                       x0 = -10,
                       x1 = 6,
                       y0 = -10,
                       y1 = 6))


fig

```


```{r echo = F, message = F}

##FGO.data = Enrichment(row.names(FDR)[FDR$AvS9FT<.05], row.names(FDR))$GO
##MGO.data = Enrichment(row.names(FDR)[FDR$AvS9MT<.05], row.names(FDR))$GO

ontology = "MF"
GO.data = MGO.data[MGO.data$ontology == ontology,
                  c("category", "term","adjp", "numDEInCat", "numInCat")]
GO.data$Female.adjp = FGO.data[row.names(GO.data), 'adjp']


data = GO.data[,c("term","numDEInCat", "numInCat", "category")]
data$MaleScore = -log10(GO.data$adjp)
data$FemaleScore = -log10(GO.data$Female.adjp)
data$term = factor(data$term, levels = c(unique(data$term)))
data$Fup = 0
data$Fdown = 0
data$Mup = 0
data$Mdown = 0
data$FmeanFC = 0
data$MmeanFC = 0

M.sigs = row.names(FDR[FDR$AvS9MT <= 0.05,])
F.sigs = row.names(FDR[FDR$AvS9FT <= 0.05,])
MFC = setNames(FC$AvS9MT, row.names(FC))
FFC = setNames(FC$AvS9FT, row.names(FC))

i = 1
while(i <= nrow(data)){
  go.id = row.names(data)[i]
  go.genes = genesingo[[go.id]]
  go.genes = GeneIDKey[GeneIDKey$ensembl %in% go.genes, "FBgn"]
  Mgo.genes = intersect(go.genes, M.sigs)
  Fgo.genes = intersect(go.genes, F.sigs)
  data$Fup[i] = length(Fgo.genes[FFC[Fgo.genes]>0])
  data$Fdown[i] = length(Fgo.genes[FFC[Fgo.genes]<0])
  data$Mup[i] = length(Mgo.genes[MFC[Mgo.genes]>0])
  data$Mdown[i] = length(Mgo.genes[MFC[Mgo.genes]<0])
  if(length(Fgo.genes)>0){
    data$FmeanFC[i] = mean(FFC[Fgo.genes])
  }
  if(length(Mgo.genes)>0){
    data$MmeanFC[i] = mean(MFC[Mgo.genes])
  }
  i = i +1
}

data$MTotalxFC = (data$MmeanFC*(data$Mup + data$Mdown))
data$FTotalxFC = (data$FmeanFC*(data$Fup + data$Fdown))

data$MTotalxFC[data$MTotalxFC != 0] = log(abs(data$MTotalxFC[data$MTotalxFC != 0]))*(data$MTotalxFC[data$MTotalxFC != 0]/abs(data$MTotalxFC[data$MTotalxFC != 0]))
data$FTotalxFC[data$FTotalxFC != 0] = log(abs(data$FTotalxFC[data$FTotalxFC != 0]))*(data$FTotalxFC[data$FTotalxFC != 0]/abs(data$FTotalxFC[data$FTotalxFC != 0]))

data$Color = data$MTotalxFC - data$FTotalxFC
data$Size = 5*log(data$numDEInCat)


fig = plot_ly(data = data,
              x = ~MTotalxFC,
              y = ~FTotalxFC,
              type = 'scatter',
              mode = 'markers',
              marker = list(colorscale = list(c(0,.45,1), c("firebrick","ivory", "royalblue")),
                            reversescale =T,
                             colorbar = list(title = "delta FC",
                                      len = .8, outlinewidth = 0,
                                      tickformat = ".2f",
                                      tick0 = 0),##, dtick = .01),
                             color = ~Color,
                             line = list(color = "black", width = 1.5),
                             size = ~Size),
              hoverinfo = "text",
              hovertext = paste("GOterm:", data$term,
                                "\nGO ID:", data$category,
                      "\nMale -log2(FDR): ", round(data$MaleScore,2),
                      "\nFemale -log2(FDR): ", round(data$FemaleScore,2),
                      "\nMale meanFC: ", round(data$MmeanFC,2),
                      "\nFemale meanFC: ", round(data$FmeanFC,2),
                      "\nIncrease FC DEG Males: ", round(data$Mup, 1),
                      "\nDecrease FC DEG Males: ", round(data$Mdown, 1),
                      "\nIncrease FC DEG Females: ", round(data$Fup, 1),
                      "\nDecrease FC DEG Females: ", round(data$Fdown, 1)))
fig = fig %>% layout(title = "",
                     shapes = list(
                       type = "line",
                       line = list(color = "black", dash = 'dash', width = 2),
                       x0 = -10,
                       x1 = 4,
                       y0 = -10,
                       y1 = 4))


fig

```


```{r echo = F, include = F}


##genes in the kegg pathway and their enzyme IDs
glycolysis.genes = read.csv('/Users/johncsantiago/Documents/GitHub/WhartonLab/GeneralDataFiles/GlycolysisGenesKEGGinfo.csv')
##Edge data for genes connecting metabolites
glycolysis.edges = read.csv('/Users/johncsantiago/Documents/GitHub/WhartonLab/GeneralDataFiles/GlycolysisEnzymeEdgesKEGGinfo.csv')
##Metabolites in the KEGG pathway with their ID
glycolysis.metabs = read.csv('/Users/johncsantiago/Documents/GitHub/WhartonLab/GeneralDataFiles/GlycolysisMetaboliteKEGGinfo.csv')

node.data = node.info('/Users/johncsantiago/Documents/GitHub/WhartonLab/TKT_RNAseq/R Code/dme00010.xml')


##extracting position data for nodes
node.info = data.frame(ID = unlist(node.data$kegg.names, use.names = F),
                       number = rep(names(node.data$kegg.names),
                                    lengths(node.data$kegg.names)),
                       x = 0,
                       y = 0,
                       color = 0,
                       names = "")
node.info$x = node.data$x[node.info$number]
node.info$y = node.data$y[node.info$number]

##make new columns for transcriptomic data
glycolysis.genes$FBgn = ""
glycolysis.genes$Symbol = ""
glycolysis.genes$FC = 0
glycolysis.genes$pval = 1

##Isolate gene ID info for goi
temp = GeneIDKey[GeneIDKey$CG %in% glycolysis.genes$CG,]
row.names(temp) = temp$CG

##fill in new columns with transcriptomic data
glycolysis.genes$FBgn = temp[glycolysis.genes$CG,'FBgn']
glycolysis.genes$Symbol = temp[glycolysis.genes$CG,'Symbol']
glycolysis.genes$FC = FC[glycolysis.genes$FBgn, 'AvS9MT']
glycolysis.genes$FDr = FDR[glycolysis.genes$FBgn, 'AvS9MT']

##make new columns for metabolomic data
row.names(glycolysis.metabs) = glycolysis.metabs$KEGG.ID
glycolysis.metabs$metabolomicsID = ""
glycolysis.metabs$FC = 0
glycolysis.metabs$pval = 1

##retrieve name used in metabolomic data for metabolite IDs in path
##including IDs associated with multiple metabolomic names
i = 1
while(i<=nrow(glycolysis.metabs)){
  if(length(grep(glycolysis.metabs$KEGG.ID[i], KEGG.Key)) > 0){
    glycolysis.metabs$metabolomicsID[i]= names(KEGG.Key[grep(glycolysis.metabs$KEGG.ID[i], KEGG.Key)])
  }
  i = i +1
}


##using the positions for nodes (metabolites) only
metab.info = node.info[node.info$ID %in% glycolysis.metabs$KEGG.ID,]



metab.info$FC = glycolysis.metabs[metab.info$ID, 'FC']
metab.info$pval = glycolysis.metabs[metab.info$ID, 'pval']
metab.info$names = glycolysis.metabs[metab.info$ID, 'Metabolite']
metab.info$color = glycolysis.metabs[metab.info$ID, 'FC']
metab.info$size = glycolysis.metabs[metab.info$ID, 'pval']

color.pallette = colorRampPalette(c('royalblue', 'grey', "firebrick"))(401)

metab.info$color[metab.info$color > 1] = 1
metab.info$color[metab.info$color < -1] = -1
metab.info$color = (metab.info$color * 200) +201
metab.info$color = color.pallette[metab.info$color]
metab.info$color[is.na(metab.info$color)] = 'dimgrey'

metab.info$size = 10 + 10*abs(metab.info$size)
metab.info$size[is.na(metab.info$size)] = 10

metab.info$title = paste0(glycolysis.metabs[metab.info$ID, "metabolomicsID"],
                          "<br>log2(FC): ", signif(metab.info$FC,3),
                          "<br>pval: ", signif(10^-metab.info$pval,3))

nodes = data.frame(id = paste0(metab.info$names),
                   color = metab.info$color,
                   size = metab.info$size,
                   x = 2*metab.info$x,
                   y = 2*metab.info$y,
                   physics = F,
                   group = "",
                   title = metab.info$title)

glycolysis.edges$FBgn = ''
temp.glycolysis.path = glycolysis.edges

i = 1
while(i<=nrow(glycolysis.edges)){
  enzymeID = paste0(glycolysis.edges$enzyme[i], "$")
  if(nrow(glycolysis.genes[grep(enzymeID, glycolysis.genes$Enzyme),])>0){
    temp = glycolysis.genes[grep(enzymeID, glycolysis.genes$Enzyme), "CG"]
    temp = row.names(GeneIDKey[GeneIDKey$CG %in% temp,])
    temp2 = glycolysis.edges[rep(i, length(temp)),]
    temp2$FBgn = temp
  }else{
    temp2 = glycolysis.edges[i,]
  }
  temp.glycolysis.path = rbind(temp.glycolysis.path,temp2)
  
  i = i +1
}

glycolysis.edges = temp.glycolysis.path[(nrow(glycolysis.edges)+1):nrow(temp.glycolysis.path),]

temp = setNames(meancpm[,'S9MT'], row.names(meancpm))
glycolysis.edges$mean.S = temp[glycolysis.edges[,'FBgn']]

temp = setNames(meancpm[,'A9MT'], row.names(meancpm))
glycolysis.edges$mean.A = temp[glycolysis.edges[,'FBgn']]

glycolysis.edges$size = log10(temp[glycolysis.edges[,'FBgn']])
glycolysis.edges$size[glycolysis.edges$size <1] = 1
glycolysis.edges$size[is.na(glycolysis.edges$size)] = 1
glycolysis.edges$size = 2*glycolysis.edges$size

glycolysis.edges$FC = FC[glycolysis.edges[,'FBgn'], 'AvS9MT']
glycolysis.edges$FDR = FDR[glycolysis.edges[,'FBgn'], 'AvS9MT']

glycolysis.edges$color = FC[glycolysis.edges[,'FBgn'], 'AvS9MT']
## max color intensity is at FC of 2
glycolysis.edges$color[glycolysis.edges$color>1] = 1
glycolysis.edges$color[glycolysis.edges$color<(-1)] = -1
glycolysis.edges$color = 201+(glycolysis.edges$color *200)
glycolysis.edges$color = color.pallette[glycolysis.edges$color]
glycolysis.edges$color[is.na(glycolysis.edges$color)] = 'dimgrey'



glycolysis.edges$title = paste0(GeneIDKey[glycolysis.edges$FBgn, "Symbol"],
                          "<br>log2(FC): ", signif(glycolysis.edges$FC,3),
                          "<br>FDR: ", signif(glycolysis.edges$FDR,3),
                          "<br> A9MT cpm: ", signif(glycolysis.edges$mean.A,3),
                          "<br>S9MT cpm: ", signif(glycolysis.edges$mean.S,3))


edges = data.frame(from = glycolysis.edges$from.name,
                   to = glycolysis.edges$to.name,
                   arrows = glycolysis.edges$arrow,
                   color = glycolysis.edges$color,
                   width = glycolysis.edges$size,
                   title = glycolysis.edges$title,
                   physics = T)

nodes = data.frame(id = paste0(nodes$id),
                   color = nodes$color,
                   size = nodes$size,
                   x = nodes$x,
                   y = nodes$y,
                   physics = F,
                   group = "",
                   title = nodes$title)

OutsidePath = data.frame(id = c('Pentose Phosphate Pathway',
                               'Propanoate Metabolism',
                               'Starch and Sucrose Metabolism',
                               'Citrate Cycle'),
                        color = "black",
                        size = 15,
                        x= c(1350,1254,966,175),
                        y=c(1112,1822,110,1700),
                        physics = F,
                        group = 'Outside Path',
                        title = "")

nodes = rbind(nodes, OutsidePath)

visNetwork(nodes, edges, main = "AvS9MT")%>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE)%>%
  visEdges(arrows = edges$arrows)%>%
  visGroups(groupname = "Outside Path", shape = 'box', physics=F, size = 25, font=list(color="white"))


```


```{r echo = F, message = F}

geneList = setNames(FC$AvS9MT, row.names(FC))
geneList = geneList[order(geneList, decreasing = T)]



```




