---
title: "A4V PCA"
author: "John Santiago"
date: "2024-01-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=F, include=F}

library(plotly)
library(edgeR)

sample.names = list.files("/Users/johncsantiago/Documents/GitHub/WhartonLab/A4V_BodySections_RNAseq/Count_Tables/")

temp = read.csv(paste0("/Users/johncsantiago/Documents/GitHub/WhartonLab/A4V_BodySections_RNAseq/Count_Tables/", sample.names[1]), sep = '\t', row.names = 1)

countdata = data.frame(temp = temp)
colnames(countdata)[1] = substr(sample.names[1], 1, nchar(sample.names[1])-15)

i=2
while(i <= length(sample.names)){
  temp = read.csv(paste0("/Users/johncsantiago/Documents/GitHub/WhartonLab/A4V_BodySections_RNAseq/Count_Tables/", sample.names[i]), sep = '\t', row.names = 1)
  countdata = cbind(countdata, temp[row.names(countdata),1])
  colnames(countdata)[i] = substr(sample.names[i], 1, nchar(sample.names[i])-15)
  i=i+1
}


##normalize data
x <- countdata
gr <- factor(substr(colnames(countdata), 1, nchar(colnames(countdata))-1))
y <- DGEList(counts=x,group=gr)
keep <- filterByExpr(y)
y <- y[keep,,keep.lib.sizes=FALSE]
z <- calcNormFactors(y, method = "TMM")
##normalized cpm
cpmdata=cpm(z)

```


```{r echo=F, include=F}

pca <- prcomp(t(cpmdata), scale.=TRUE) 
gr <- colnames(cpmdata)
PC1=scale(pca$x[,1])
PC2=scale(pca$x[,2])
eigs <- pca$sdev^2
ve=signif(((eigs / sum(eigs))*100)[1:3],4)
      
    pca.data=data.frame(Sample=gr,
                        ##PC1=scale(pca$x[,1]),
                        ##PC2=scale(pca$x[,2]),
                        PC1=scale(pca$x[,1]),
                        PC2=scale(pca$x[,2]),
                        sdev=pca$sdev,
                        Genotype=substr(gr, 1, 1), 
                        Sex=substr(gr, nchar(gr)-2, nchar(gr)-2), 
                        Age=substr(gr, 2, nchar(gr)-3),
                        Percent1=ve[1],
                        Percent2=ve[2],
                        Group= paste0(substr(gr, 1, 1),
                                      substr(gr, nchar(gr)-2, nchar(gr)-1)),
                        pca.color = substr(gr, nchar(gr)-1, nchar(gr)-1),
                        pca.shape = substr(gr, nchar(gr)-2, nchar(gr)-2))
    
    
fig  = plot_ly(data = pca.data, 
                 x = ~PC1, 
                 y = ~PC2,
                 name = ~Group,
                 type = 'scatter',
                 mode = 'markers',
                 showlegend = T,
                 color = ~pca.color,
                 symbol = ~pca.shape,
                 ##symbols = as.character(seq_along(unique(point.data$Set))),
                 ##colors = c(input$color1, input$color2, input$color3)[c(1:length(levels(pca.color)))],
                 marker = list(size = 15,
                               line = list(color = "black", width = 1.5)),
                 hoverinfo = "text",
                 hovertext = paste("Sample:", pca.data$Sample)) %>%
    layout(xaxis = list(title = paste0("PC 1", "(", pca.data$Percent1[1], "%)")),
           yaxis = list(title = paste0("PC 2", "(", pca.data$Percent2[2], "%)")))
```

```{r}

  fig

```